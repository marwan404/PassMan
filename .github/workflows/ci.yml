name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, 3.13]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black ruff pre-commit pytest

      - name: Run pre-commit
        run: python -m pre_commit run --all-files

      - name: Check formatting (Black)
        run: python -m black --check .

      - name: Lint (Ruff)
        run: python -m ruff check .

      - name: Run tests with coverage
        run: |
          python -m pip install coverage codecov
          coverage run -m pytest -q
          coverage xml -i

      - name: Check Codecov token
        if: ${{ matrix.python-version == '3.11' }}
        id: check-codecov
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          if [ -z "$CODECOV_TOKEN" ]; then
            echo "codecov_present=false" >> $GITHUB_OUTPUT
          else
            echo "codecov_present=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage to Codecov
        if: ${{ matrix.python-version == '3.11' && steps.check-codecov.outputs.codecov_present == 'true' }}
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

      - name: Notify about skipped Codecov upload
        if: ${{ matrix.python-version == '3.11' && steps.check-codecov.outputs.codecov_present == 'false' }}
        run: |
          echo "---"
          echo "Codecov upload skipped because repository secret CODECOV_TOKEN is not set."
          echo "To enable uploads on protected branches, either add the CODECOV_TOKEN secret (Settings → Secrets and variables → Actions) or install the Codecov GitHub App for this repository."
          echo "See https://docs.codecov.com/docs/codecov-tokens for token details."

      - name: Security scan (Bandit)
        run: |
          python -m pip install bandit
          bandit -r . -ll || true
